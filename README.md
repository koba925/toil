# toil

学習用の言語処理系について、実装しながら考えたり検証したりします。

## 狙い

[350行くらいのPythonで作るプログラミング言語実装超入門](https://zenn.dev/kb84tkhr/books/mini-interpreter-in-350-lines)（以下「350行言語」）のような書籍のネタにするための言語処理系を考える。

以下のような点で差異化する。

* 最初に評価器を作る。
  350行言語では、なぜ構文解析が出てくるのかうまく説明できなかった。
  最初に、コンピュータで処理しやすい形から入り、その後人間のための形を追加するという流れにする。
* 最初の評価器はとにかく小さく作り、最初の敷居を下げる。ここだけ読んでも意義があるようにする。
* 最終的な行数にはこだわらない。
* マクロを導入する。
* 簡易的なカスタム文法を導入する。
* ツリーウォーク型の処理系だけではなく、中間言語へのコンパイル＋仮想マシンの形でも実装する。

以下の点は継続する。

* できるだけ平易なコードを書く。
* できるだけ予備知識を減らす。
* エラー処理や性能については問わず、言語処理系の原理の学習に的を絞る。

## これまでの実験

これまでの実験は以下にある。

* https://github.com/koba925/toig
* [トイ言語実験日記（マクロと継続）](https://zenn.dev/kb84tkhr/scraps/133254ba6599e4)
* [トイ言語実験日記２（構文解析とカスタム文法）](https://zenn.dev/kb84tkhr/scraps/344aa65443b4f3)
* [トイ言語実験日記３（ステートマシンでマクロと継続）](https://zenn.dev/kb84tkhr/scraps/446dd0e90c3fc3)
* [トイ言語実験日記４（テーマ未定)](https://zenn.dev/kb84tkhr/scraps/6f94737d864eef)
* [トイ言語実験日記５（中間コードインタプリタ）](https://zenn.dev/kb84tkhr/scraps/6903a2797fee46)
* [トイ言語実験日記６（toigでeval）](https://zenn.dev/kb84tkhr/scraps/9ea61135b3c146)

## 開発方針

* 言語処理系の原理を学習することを主要な目的とし、そのための最小限の実装を行う。
* 細かいステップでインクリメンタルに開発する。
* 標準・サードパーティ問わずライブラリの利用はできるだけ控える。ただしテスト用にpytestのみ導入する。
* 「後で必要になるから」と必然性のないコードはできるだけ入れないようにし、必要になったときに初めてコードを追加する。

## アーキテクチャ

* 値はPythonの値をそのまま用いる。
  * ただし、文字列は最初の段階ではシンボルを表すものとする。
  * 字句解析・構文解析を導入する段階でシンボルを表す型を導入して文字列が文字列を表すようにする。
* ASTはタプルで表す。
* 環境はdictを用い、ミュータブルな構造として実装する。
* 仮想マシンはスタックマシンとして実装する。

## 開発ステップ

以下のような段階を踏んで開発を進める。

* 最小のツリーウォーク式評価器を実装する。
  * 値を実装する。扱う値はNone、bool、intのみ。
  * if式を実装する。if-then-else-endの形で、elifは後にする。
  * 変数（定義・参照）を評価する。
  * 組み込み関数（add・sub・mul・equal・print）、ユーザ定義関数、クロージャ
  * 再帰でフィボナッチ数が求められる。
* 最小の字句解析・（再帰下降）構文解析を実装する。
  * 構文解析の学習のため、四則演算や比較などは演算子で表し、優先度も持たせる。
  * 演算子は構文解析で組み込み関数に変換する。
* 機能を拡張する。
  * 組み込み関数を追加する。
  * whileを実装する。
  * breakを実装する。
  * continueを実装する。
  * returnを実装する。
  * 配列を実装する。
    配列の生成にはarr()関数を用い、特別な構文は用意しない。参照には[]を用いる。
  * 文字列を実装する。
  * タプルを実装する。
    ASTをタプルで表すのでマクロの実装にはタプルが扱えることが必要だと思われる。
  * マクロを実装する。
    この段階では関数に近い実装で、評価中にマクロを展開するようにする。
  * マクロでanaphoric-ifを実装する。
  * anaphoric-ifを使ってand、orを実装する。
* 中間言語へコンパイルして仮想マシンで動かす。字句解析・構文解析はそのまま利用する。
  * 仮想マシンをゼロから実装しつつ、値、if、・・・とやはりインクリメンタルに実装する。
* 事前に展開する形のマクロを実装する。
  * 構文解析と実行の間にマクロ展開のフェーズを入れてASTを変換する。
* 継続を実装する。
  * 継続でbreak、continue、returnを実装する。

# コーディング規約

* 書籍で説明する予定であることと、コードを短く見通しよくしたいことからコードにはコメントを入れない。
  * コメントを入れなくても読みやすいコードになるよう心がける。
  * ただし、変数名や関数名は長すぎないようにする。
* 引用符はダブルクォーテーションを使う。
* 見通せる範囲の情報量を増やすため、PEP-8にしたがえば改行を入れるところでも入れない場合がある。
* 0や1はFalse・Trueやその他の特別な値と混乱する場合があるため、テストで使う数は2から始める。
